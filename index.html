<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turf Master | Premium Slot Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root {
      --primary: #00d1b2;
      --turf-dark: #0a2e1f;
      --turf-green: #2b7a56;
      --turf-bright: #32ff7e;
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top right, #1a4731, #0a1f16);
      color: #e0e0e0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .hero-glass {
      background: linear-gradient(135deg, rgba(43, 122, 86, 0.2), rgba(10, 46, 31, 0.8));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      padding: 3rem 1rem;
    }

    .glass-card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
      margin-bottom: 2rem;
    }

    .label {
      color: #b0d4c1 !important;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .input {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid var(--glass-border) !important;
      color: white !important;
      border-radius: 10px !important;
      height: 3rem;
    }

    .input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .input:focus {
      border-color: var(--turf-bright) !important;
      box-shadow: 0 0 10px rgba(50, 255, 126, 0.2) !important;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 1rem;
    }

    .slot-btn {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--glass-border);
      padding: 15px 5px;
      text-align: center;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.85rem;
      color: #ccc;
    }

    .slot-btn:hover:not(.is-disabled):not(.is-booked) {
      background: rgba(50, 255, 126, 0.1);
      border-color: var(--turf-bright);
      transform: translateY(-3px);
      color: white;
    }

    .slot-btn.is-selected {
      background: var(--turf-bright);
      color: #0a2e1f;
      border-color: var(--turf-bright);
      font-weight: 700;
      box-shadow: 0 0 15px rgba(50, 255, 126, 0.5);
    }

    .slot-btn.is-disabled {
      opacity: 0.3;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .slot-btn.is-booked {
      background: rgba(241, 70, 104, 0.1);
      color: #f14668;
      border-color: rgba(241, 70, 104, 0.4);
      cursor: not-allowed;
      font-weight: bold;
    }

    /* Custom File Upload Styling */
    .file-input-wrapper {
      background: rgba(255, 255, 255, 0.05);
      border: 2px dashed var(--glass-border);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-input-wrapper:hover {
      border-color: var(--turf-bright);
      background: rgba(50, 255, 126, 0.05);
    }

    .file-input-wrapper input {
      position: absolute;
      opacity: 0;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    #photoPreview {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
      border: 1px solid var(--glass-border);
    }

    .booking-bar {
      background: rgba(0, 0, 0, 0.4);
      padding: 1rem 2rem;
      border-radius: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
    }

    .btn-book {
      background: linear-gradient(90deg, #2ecc71, #27ae60);
      color: white;
      border: none;
      padding: 1rem 3rem;
      border-radius: 50px;
      font-weight: 700;
      font-size: 1.1rem;
      transition: all 0.3s;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-book:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
      filter: brightness(1.1);
    }

    .btn-book:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .debug-panel {
      font-size: 0.75rem;
      color: #666;
      border-top: 1px solid var(--glass-border);
      padding-top: 1rem;
      margin-top: 3rem;
    }
  </style>
</head>

<body>

  <section class="hero-glass has-text-centered">
    <div style="position: absolute; top: 1rem; right: 1rem;">
      <a href="admin.html" class="button is-small is-primary is-outlined" style="border-radius: 20px;">Admin Login</a>
    </div>
    <div class="container">
      <h1 class="title is-1 has-text-white has-text-weight-bold">TURF <span
          style="color:var(--turf-bright)">MASTER</span></h1>
      <p class="subtitle has-text-grey-light">Unleash Your Game | Premium Slot Booking</p>
    </div>
  </section>

  <div class="container mt-6 px-4">
    <div class="columns is-centered">
      <div class="column is-10">
        <form id="bookingForm" class="glass-card">
          <div class="columns is-multiline">
            <div class="column is-4">
              <label class="label">FULL NAME</label>
              <input class="input" type="text" name="User" placeholder="e.g. Cristiano Ronaldo" required />
            </div>
            <div class="column is-4">
              <label class="label">MOBILE NUMBER</label>
              <input class="input" type="tel" name="Mobile_Number" pattern="[0-9]{10}" placeholder="10 Digit Mobile"
                required />
            </div>
            <div class="column is-4">
              <label class="label">BOOKING DATE</label>
              <input class="input" type="date" name="Select_Date" id="bookingDate" required />
            </div>
          </div>

          <div class="mt-5" style="position: relative;">
            <label class="label">SELECT YOUR SLOTS (<span id="priceLabel">Loading price...</span>)</label>
            <div id="loader" class="notification is-dark py-2 has-text-centered is-size-7" style="display:none">
              Searching live availability...</div>
            <div class="slot-grid" id="slotGrid"></div>
            <input type="hidden" name="Select Time Slots (500 per hr)" id="selectedSlotsInput" required />
          </div>

          <div class="columns mt-6">
            <div class="column is-7">
              <label class="label">PHOTO ID PROOF (Required)</label>
              <div class="file-input-wrapper">
                <p id="fileLabel">Click or Drag to Upload ID Proof</p>
                <input type="file" id="photoIdInput" accept="image/*" required />
                <img id="photoPreview" alt="ID Proof Preview" />
              </div>
            </div>
            <div class="column is-5">
              <div class="is-flex is-flex-direction-column is-justify-content-center" style="height:100%">
                <div class="is-flex is-justify-content-between mb-2">
                  <span class="has-text-grey">Slots Selected:</span>
                  <span id="slotCount" class="has-text-weight-bold">0</span>
                </div>
                <div class="is-flex is-justify-content-between mb-4">
                  <span class="has-text-grey">Total Amount:</span>
                  <span class="is-size-3 has-text-white has-text-weight-bold">₹<span id="totalAmount">0</span></span>
                </div>
                <button type="submit" id="submitBtn" class="btn-book">SECURE BOOKING</button>
              </div>
            </div>
          </div>

          <!-- Hidden tracking fields -->
          <input type="hidden" name="Total_Amount" id="hiddenAmount" />
          <input type="hidden" name="Payment_Status" id="hiddenStatus" value="Pending" />
          <input type="hidden" name="Transaction_ID" id="hiddenTxn" />
        </form>

        <div id="message" class="notification notification-glass" style="display:none; background: rgba(0,0,0,0.6);">
        </div>

        <div class="debug-panel has-text-centered">
          <p>SERVER: <span id="serverStatus">Checking...</span> | VERSION: V9-IMAGE-UPLOAD</p>
          <button type="button" class="button is-ghost is-small" onclick="location.reload()">Manual Sync</button>
        </div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let PRICE_PER_SLOT = 500; // Default fallback

    let selectedSlots = [];
    let bookedSlots = [];
    let photoBase64 = null;
    let photoName = null;

    // Elements
    const bookingForm = document.getElementById("bookingForm");
    const dateInput = document.getElementById("bookingDate");
    const slotGrid = document.getElementById("slotGrid");
    const photoIdInput = document.getElementById("photoIdInput");
    const photoPreview = document.getElementById("photoPreview");
    const fileLabel = document.getElementById("fileLabel");
    const submitBtn = document.getElementById("submitBtn");
    const priceLabel = document.getElementById("priceLabel");

    // Fetch dynamic price on load
    async function fetchPricing() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=fetchPricing`, { redirect: 'follow' });
        const data = await res.json();
        if (data.status === "success") {
          const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
          const currentDay = days[new Date().getDay()];
          const dayPrice = data.pricing[currentDay];

          if (dayPrice) {
            PRICE_PER_SLOT = parseInt(dayPrice);
            priceLabel.innerText = `₹${PRICE_PER_SLOT}/hr`;
            updateUI(); // Refresh totals if already selected
          } else {
            priceLabel.innerText = "Price unavailable";
          }
        }
      } catch (e) {
        console.error("Pricing fetch failed:", e);
        priceLabel.innerText = "Price unavailable";
      }
    }

    // Init Date
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    dateInput.value = today;

    // Slots Data
    const hours = Array.from({ length: 24 }, (_, i) => {
      const h = i % 12 || 12;
      const ampm = i < 12 ? 'AM' : 'PM';
      const label = `${h.toString().padStart(2, '0')} ${ampm} - ${(i + 1) % 12 || 12}${i + 1 < 12 || (i + 1 === 24) ? ' AM' : ' PM'}`;
      return { label, start: i };
    });

    // Handle Image Preview
    photoIdInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        photoName = file.name;
        fileLabel.innerText = "Processing Image...";
        const reader = new FileReader();
        reader.onload = function (event) {
          photoBase64 = event.target.result;
          photoPreview.src = photoBase64;
          photoPreview.style.display = "block";
          fileLabel.innerText = `ID Locked: ${file.name}`;
        };
        reader.readAsDataURL(file);
      }
    });

    async function syncAvailability() {
      document.getElementById("loader").style.display = "block";
      try {
        const res = await fetch(`${SCRIPT_URL}?date=${dateInput.value}`, { redirect: 'follow' });
        const data = await res.json();
        bookedSlots = data.bookedSlots || [];
        document.getElementById("serverStatus").innerText = "CONNECTED";
      } catch (e) {
        document.getElementById("serverStatus").innerText = "SYNC ERROR";
      } finally {
        document.getElementById("loader").style.display = "none";
        renderSlots();
      }
    }

    function renderSlots() {
      slotGrid.innerHTML = "";
      const isToday = dateInput.value === today;
      const currentHour = new Date().getHours();

      hours.forEach(slot => {
        const div = document.createElement("div");
        const isPast = isToday && slot.start <= currentHour;
        const isOccupied = bookedSlots.includes(slot.label);

        div.className = "slot-btn";
        if (isPast) div.classList.add("is-disabled");
        if (isOccupied) div.classList.add("is-booked");
        if (selectedSlots.includes(slot.label)) div.classList.add("is-selected");

        div.innerText = slot.label;

        if (!isPast && !isOccupied) {
          div.onclick = () => {
            if (selectedSlots.includes(slot.label)) {
              selectedSlots = selectedSlots.filter(s => s !== slot.label);
            } else {
              selectedSlots.push(slot.label);
            }
            updateUI();
            renderSlots();
          };
        }
        slotGrid.appendChild(div);
      });
    }

    function updateUI() {
      document.getElementById("slotCount").innerText = selectedSlots.length;
      document.getElementById("totalAmount").innerText = selectedSlots.length * PRICE_PER_SLOT;
      document.getElementById("hiddenAmount").value = selectedSlots.length * PRICE_PER_SLOT;
      document.getElementById("selectedSlotsInput").value = selectedSlots.join(", ");
    }

    dateInput.onchange = () => { selectedSlots = []; updateUI(); syncAvailability(); };

    bookingForm.onsubmit = async (e) => {
      e.preventDefault();
      if (selectedSlots.length === 0) return alert("Select at least one slot!");
      if (!photoBase64) return alert("Photo ID is mandatory!");

      submitBtn.disabled = true;
      submitBtn.innerText = "PREPARING PAYMENT...";

      try {
        const formData = Object.fromEntries(new FormData(bookingForm));
        const amountPaise = parseInt(formData.Total_Amount) * 100;

        // Step 1: Create RZP Order
        const orderRes = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "createOrder", amount: amountPaise }),
          redirect: "follow"
        });
        const order = await orderRes.json();
        if (order.status !== "success") throw new Error(order.message);

        // Step 2: Open RZP Checkout
        const options = {
          "key": order.key_id,
          "amount": order.amount,
          "currency": order.currency,
          "name": "TURF MASTER",
          "description": `Booking for ${selectedSlots.length} slots`,
          "order_id": order.orderId,
          "handler": async function (response) {
            submitBtn.innerText = "VERIFYING & LOCKING SLOTS...";
            const verifyRes = await fetch(SCRIPT_URL, {
              method: "POST",
              body: JSON.stringify({
                action: "verifyAndSave",
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                bookingData: formData,
                photoIdData: photoBase64,
                photoIdName: photoName
              }),
              redirect: "follow"
            });
            const result = await verifyRes.json();
            if (result.status === "success") {
              alert("BOOKING CONFIRMED!\nTransaction ID: " + response.razorpay_payment_id);
              location.reload();
            } else {
              alert("Verification Error: " + result.message);
            }
          },
          "prefill": { "name": formData.User, "contact": formData.Mobile_Number },
          "theme": { "color": "#00d1b2" },
          "modal": { "ondismiss": () => { submitBtn.disabled = false; submitBtn.innerText = "SECURE BOOKING"; } }
        };
        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        alert("Operation Failed: " + err.message);
        submitBtn.disabled = false;
        submitBtn.innerText = "SECURE BOOKING";
      }
    };

    // Initial Load
    syncAvailability();

  </script>
</body>

</html>